name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-macos-arm64:
    name: Build macOS arm64
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          brew install cmake libomp openblas
          # FAISS needs to be built from source on macOS GitHub Actions
          LIBOMP_PREFIX=$(brew --prefix libomp)
          git clone https://github.com/facebookresearch/faiss.git /tmp/faiss
          cd /tmp/faiss
          # Set OpenMP paths for CMake (both C and CXX) - include path is critical for omp.h
          export OpenMP_CXX_FLAGS="-Xpreprocessor -fopenmp -Wno-unused-command-line-argument -I${LIBOMP_PREFIX}/include"
          export OpenMP_CXX_LIB_NAMES="omp"
          export OpenMP_omp_LIBRARY="${LIBOMP_PREFIX}/lib/libomp.dylib"
          export OpenMP_C_FLAGS="-Xpreprocessor -fopenmp -Wno-unused-command-line-argument -I${LIBOMP_PREFIX}/include"
          export OpenMP_C_LIB_NAMES="omp"
          export OpenMP_gomp_LIBRARY="${LIBOMP_PREFIX}/lib/libomp.dylib"
          cmake -B build \
            -DFAISS_ENABLE_GPU=OFF \
            -DFAISS_ENABLE_PYTHON=OFF \
            -DBUILD_TESTING=OFF \
            -DOpenMP_CXX_FLAGS="-Xpreprocessor -fopenmp -Wno-unused-command-line-argument -I${LIBOMP_PREFIX}/include" \
            -DOpenMP_CXX_LIB_NAMES="omp" \
            -DOpenMP_omp_LIBRARY="${LIBOMP_PREFIX}/lib/libomp.dylib" \
            -DOpenMP_C_FLAGS="-Xpreprocessor -fopenmp -Wno-unused-command-line-argument -I${LIBOMP_PREFIX}/include" \
            -DOpenMP_C_LIB_NAMES="omp" \
            -DOpenMP_gomp_LIBRARY="${LIBOMP_PREFIX}/lib/libomp.dylib"
          cmake --build build -j$(sysctl -n hw.ncpu)
          sudo cmake --install build
          cd -
      
      - name: Install npm dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Test
        run: npm run test:ci
      
      - name: Package
        run: |
          mkdir -p dist
          tar -czf dist/faiss-node-macos-arm64.tar.gz build/Release/faiss_node.node
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: dist/faiss-node-macos-arm64.tar.gz

  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libopenblas-dev libomp-dev build-essential
          # Build FAISS from source
          git clone https://github.com/facebookresearch/faiss.git /tmp/faiss
          cd /tmp/faiss
          cmake -B build \
            -DFAISS_ENABLE_GPU=OFF \
            -DFAISS_ENABLE_PYTHON=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DCMAKE_CXX_FLAGS="-fopenmp" \
            -DCMAKE_C_FLAGS="-fopenmp"
          cmake --build build -j$(nproc)
          echo "=== Installing FAISS ==="
          sudo cmake --install build
          echo "=== Verifying FAISS installation ==="
          # Check if headers were installed
          if [ ! -d /usr/local/include/faiss ]; then
            echo "❌ ERROR: /usr/local/include/faiss directory not found after install!"
            echo "Checking /usr/local/include:"
            ls -la /usr/local/include/ | head -20
            echo "Checking build directory for headers:"
            find build -name "*.h" -path "*/faiss/*" | head -10
            exit 1
          fi
          if [ ! -f /usr/local/include/faiss/impl/FaissAssert.h ]; then
            echo "❌ ERROR: /usr/local/include/faiss/impl/FaissAssert.h not found!"
            echo "Checking /usr/local/include/faiss:"
            ls -la /usr/local/include/faiss/ | head -20
            echo "Checking for impl directory:"
            ls -la /usr/local/include/faiss/impl/ 2>&1 | head -20 || echo "impl directory doesn't exist"
            exit 1
          fi
          echo "✅ FAISS headers verified: /usr/local/include/faiss/impl/FaissAssert.h exists"
          echo "✅ FAISS library check:"
          ls -la /usr/local/lib/libfaiss* || echo "⚠️ No libfaiss found (might be static)"
          # Double-check installation
          echo "=== Final FAISS installation check ==="
          find /usr/local/include -name "FaissAssert.h" 2>/dev/null || echo "⚠️ FaissAssert.h not found in /usr/local/include"
          ls -la /usr/local/include/faiss/ | head -10
          ls -la /usr/local/lib/libfaiss* || echo "No libfaiss found"
          cd -
      
      - name: Install npm dependencies (skip build)
        run: npm ci --ignore-scripts
      
      - name: Build
        run: |
          echo "=== Verifying FAISS installation before build ==="
          if [ ! -d /usr/local/include/faiss ]; then
            echo "❌ ERROR: /usr/local/include/faiss directory not found!"
            echo "Checking what was installed:"
            ls -la /usr/local/include/ | head -10
            exit 1
          fi
          ls -la /usr/local/include/faiss/ | head -5
          if [ ! -f /usr/local/include/faiss/impl/FaissAssert.h ]; then
            echo "❌ ERROR: /usr/local/include/faiss/impl/FaissAssert.h not found!"
            echo "Checking impl directory:"
            ls -la /usr/local/include/faiss/impl/ | head -10 || echo "impl directory doesn't exist"
            echo "Searching for FaissAssert.h:"
            find /usr/local -name "FaissAssert.h" 2>/dev/null || echo "Not found anywhere"
            exit 1
          fi
          echo "✅ FAISS headers verified"
          ls -la /usr/local/lib/libfaiss* || echo "No libfaiss found"
          echo "=== Building native module ==="
          echo "Testing include path:"
          g++ -E -x c++ - -I/usr/local/include <<< '#include <faiss/impl/FaissAssert.h>' 2>&1 | head -5 || echo "Include test failed"
          echo "=== Checking binding.gyp ==="
          cat binding.gyp | grep -A 5 "OS=='linux'"
          echo "=== Building with explicit include path ==="
          export CPPFLAGS="-I/usr/local/include"
          export CXXFLAGS="-I/usr/local/include"
          export LDFLAGS="-L/usr/local/lib"
          npm run build
      
      - name: Test
        run: npm run test:ci
      
      - name: Package
        run: |
          mkdir -p dist
          tar -czf dist/faiss-node-linux-x64.tar.gz build/Release/faiss_node.node
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: dist/faiss-node-linux-x64.tar.gz

  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-latest
    continue-on-error: true  # Windows builds are optional, WSL2/Docker recommended
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Setup vcpkg
        uses: microsoft/setup-vcpkg@v3
        with:
          vcpkgGitCommitSha: 'HEAD'
      
      - name: Install dependencies with vcpkg
        run: |
          vcpkg install openblas:x64-windows --triplet x64-windows
          # Note: FAISS is not available in vcpkg, so we need to build from source
          # This is complex on Windows, so WSL2/Docker is recommended
      
      - name: Build FAISS from source (Windows)
        id: build_faiss
        run: |
          echo "⚠️ Windows native builds are complex. WSL2/Docker is recommended."
          echo "See WINDOWS.md for setup instructions."
          echo "Skipping Windows native FAISS build - users should use WSL2/Docker."
          echo "FAISS_INSTALLED=false" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true
        shell: bash
      
      - name: Install npm dependencies
        run: npm ci --ignore-scripts
        continue-on-error: true
      
      - name: Check if FAISS is installed
        id: check_faiss
        run: |
          if [ -d "C:/faiss-install/include/faiss" ] || [ -d "C:/faiss/include" ]; then
            echo "FAISS_FOUND=true" >> $GITHUB_OUTPUT
            echo "✅ FAISS headers found"
          else
            echo "FAISS_FOUND=false" >> $GITHUB_OUTPUT
            echo "⚠️ FAISS headers not found - skipping Windows native build"
          fi
        continue-on-error: true
        shell: bash
      
      - name: Build (Windows)
        if: steps.check_faiss.outputs.FAISS_FOUND == 'true'
        run: |
          echo "Building with FAISS found at C:/faiss-install"
          $env:INCLUDE = "C:\faiss-install\include;$env:INCLUDE"
          $env:LIB = "C:\faiss-install\lib;$env:LIB"
          $env:PATH = "C:\faiss-install\bin;$env:PATH"
          npm run build
        continue-on-error: true
        shell: pwsh
        env:
          VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
      
      - name: Skip Build (Windows - FAISS not installed)
        if: steps.check_faiss.outputs.FAISS_FOUND != 'true'
        run: |
          echo "⚠️ Windows native builds require FAISS to be installed."
          echo "FAISS is not installed, so skipping build."
          echo "Windows users should use WSL2, VS Code Dev Container, or Docker Desktop."
          echo "See WINDOWS.md for detailed setup instructions."
          exit 0
        continue-on-error: true
        shell: bash
      
      - name: Test (Windows)
        if: steps.check_faiss.outputs.FAISS_FOUND == 'true' && success()
        run: npm run test:ci
        continue-on-error: true
      
      - name: Package (Windows)
        if: steps.check_faiss.outputs.FAISS_FOUND == 'true' && success()
        run: |
          if (Test-Path "build\Release\faiss_node.node") {
            New-Item -ItemType Directory -Force -Path dist | Out-Null
            Compress-Archive -Path build\Release\faiss_node.node -DestinationPath dist\faiss-node-windows-x64.zip -Force
            echo "✅ Windows binary packaged"
          } else {
            echo "⚠️ Windows binary not found"
          }
        continue-on-error: true
        shell: pwsh
      
      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: dist/faiss-node-windows-x64.tar.gz
        continue-on-error: true

  publish-npm:
    name: Publish to npm
    needs: [build-macos-arm64, build-linux-x64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
      
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Update package.json version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          TARGET_VERSION="${{ steps.version.outputs.VERSION }}"
          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            npm version $TARGET_VERSION --no-git-tag-version
          else
            echo "✅ Version already matches: $CURRENT_VERSION"
          fi
      
      - name: Install dependencies
        run: npm ci --ignore-scripts
      
      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_IGNORE_SCRIPTS: true
      
      - name: Verify publication
        run: |
          sleep 5
          npm view @faiss-node/native@${{ steps.version.outputs.VERSION }} version || echo "Package may take a few minutes to appear"

  create-release:
    name: Create Release
    needs: [build-macos-arm64, build-linux-x64, build-windows-x64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: '**/*.tar.gz'
          if-no-files-found: warn
      
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: List artifacts
        run: |
          echo "=== Artifacts found ==="
          find dist -type f -name "*.tar.gz" 2>/dev/null || echo "No artifacts found"
          ls -la dist/ 2>/dev/null || echo "dist directory not found"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          files: |
            dist/**/*.tar.gz
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
